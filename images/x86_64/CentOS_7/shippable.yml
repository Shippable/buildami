#
# Resources
#
resources:
  - name: c7baseami_params
    type: params
    version:
      params:
        SOURCE_AMI: "ami-ae7bfdb8"
        VPC_ID: "vpc-266f3241"
        SUBNET_ID: "subnet-6df12f24"
        SECURITY_GROUP_ID: "sg-f634518c"
        REGION: "us-east-1"

  - name: c7_dd_repo
    type: gitRepo
    integration: avinci_gh
    pointer:
      sourceName: dry-dock/c7
      branch: master

  - name: c7_dd_img
    type: image
    integration: shipDH
    pointer:
      sourceName: "drydock/c7"
    seed:
      versionName: master

  - name: c7all_dd_repo
    type: gitRepo
    integration: avinci_gh
    pointer:
      sourceName: dry-dock/c7all
      branch: master

  - name: c7all_dd_img
    type: image
    integration: shipDH
    pointer:
      sourceName: "drydock/c7all"
    seed:
      versionName: master

  - name: c7nodall_dd_repo
    type: gitRepo
    integration: avinci_gh
    pointer:
      sourceName: dry-dock/c7nodall
      branch: master

  - name: c7nodall_dd_img
    type: image
    integration: shipDH
    pointer:
      sourceName: "drydock/c7nodall"
    seed:
      versionName: master

  - name: c7pytall_dd_repo
    type: gitRepo
    integration: avinci_gh
    pointer:
      sourceName: dry-dock/c7pytall
      branch: master

  - name: c7pytall_dd_img
    type: image
    integration: shipDH
    pointer:
      sourceName: "drydock/c7pytall"
    seed:
      versionName: master

  - name: c7javall_dd_repo
    type: gitRepo
    integration: avinci_gh
    pointer:
      sourceName: dry-dock/c7javall
      branch: master

  - name: c7javall_dd_img
    type: image
    integration: shipDH
    pointer:
      sourceName: "drydock/c7javall"
    seed:
      versionName: master

  - name: c7cppall_dd_repo
    type: gitRepo
    integration: avinci_gh
    pointer:
      sourceName: dry-dock/c7cppall
      branch: master

  - name: c7cppall_dd_img
    type: image
    integration: shipDH
    pointer:
      sourceName: "drydock/c7cppall"
    seed:
      versionName: master

jobs:
  - name: c7_x8664_build
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    runtime:
      nodePool: c7_cache
    steps:
      - IN: c7_dd_repo
      - TASK:
          name: c7_build
          runtime:
            options:
              env:
                - REL_VER: "master"
                - IMG_OUT: "c7_dd_img"
                - RES_REPO: "c7_dd_repo"
          script:
            - *build_ship_assets
      - OUT: c7_dd_img
    on_success:
      script:
        - *build_ship_assets_on_success

  - name: c7all_x8664_build
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    runtime:
      nodePool: c7_cache
    steps:
      - IN: c7all_dd_repo
      - IN: c7_dd_img
      - TASK:
          name: c7all_build
          runtime:
            options:
              env:
                - REL_VER: "master"
                - RES_REPO: "c7all_dd_repo"
                - IMG_OUT: "c7all_dd_img"
          script:
            - *build_ship_assets
      - OUT: c7all_dd_img
    on_success:
      script:
        - *build_ship_assets_on_success

  - name: c7nodall_x8664_build
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    runtime:
      nodePool: c7_cache
    steps:
      - IN: c7nodall_dd_repo
      - IN: c7all_dd_img
      - TASK:
          name: c7nodall_build
          runtime:
            options:
              env:
                - REL_VER: "master"
                - RES_REPO: "c7nodall_dd_repo"
                - IMG_OUT: "c7nodall_dd_img"
          script:
            - *build_ship_assets
      - OUT: c7nodall_dd_img
    on_success:
      script:
        - *build_ship_assets_on_success

  - name: c7pytall_x8664_build
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    runtime:
      nodePool: c7_cache
    steps:
      - IN: c7pytall_dd_repo
      - IN: c7all_dd_img
      - TASK:
          name: c7pytall_build
          runtime:
            options:
              env:
                - REL_VER: "master"
                - RES_REPO: "c7pytall_dd_repo"
                - IMG_OUT: "c7pytall_dd_img"
          script:
            - *build_ship_assets
      - OUT: c7pytall_dd_img
    on_success:
      script:
        - *build_ship_assets_on_success

  - name: c7javall_x8664_build
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    runtime:
      nodePool: c7_cache
    steps:
      - IN: c7javall_dd_repo
      - IN: c7all_dd_img
      - TASK:
          name: c7pytall_build
          runtime:
            options:
              env:
                - REL_VER: "master"
                - RES_REPO: "c7javall_dd_repo"
                - IMG_OUT: "c7javall_dd_img"
          script:
            - *build_ship_assets
      - OUT: c7javall_dd_img
    on_success:
      script:
        - *build_ship_assets_on_success

  - name: c7cppall_x8664_build
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    runtime:
      nodePool: c7_cache
    steps:
      - IN: c7cppall_dd_repo
      - IN: c7all_dd_img
      - TASK:
          name: c7cppall_build
          runtime:
            options:
              env:
                - REL_VER: "master"
                - RES_REPO: "c7cppall_dd_repo"
                - IMG_OUT: "c7cppall_dd_img"
          script:
            - *build_ship_assets
      - OUT: c7cppall_dd_img
    on_success:
      script:
        - *build_ship_assets_on_success

####
  - name: c7_x8664_tag
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    integrations:
      - ship_ssh
    steps:
      - IN: prod_release
      - IN: c7_dd_repo
        switch: off
      - IN: c7_dd_img
        switch: off
      - TASK:
          name: c7_tag
          runtime:
            options:
              env:
                - RES_VER: "prod_release"
                - RES_IMG: "c7_dd_img"
                - RES_REPO: "c7_dd_repo"
          script:
            - *tag_ship_assets
    on_success:
      script:
        - *tag_ship_assets_on_success

  - name: c7all_x8664_tag
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    integrations:
      - ship_ssh
    steps:
      - IN: prod_release
      - IN: c7all_dd_repo
        switch: off
      - IN: c7all_dd_img
        switch: off
      - TASK:
          name: c7all_tag
          runtime:
            options:
              env:
                - RES_VER: "prod_release"
                - RES_IMG: "c7all_dd_img"
                - RES_REPO: "c7all_dd_repo"
          script:
            - *tag_ship_assets
    on_success:
      script:
        - *tag_ship_assets_on_success

  - name: c7nodall_x8664_tag
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    integrations:
      - ship_ssh
    steps:
      - IN: prod_release
      - IN: c7nodall_dd_repo
        switch: off
      - IN: c7nodall_dd_img
        switch: off
      - TASK:
          name: c7nodall_tag
          runtime:
            options:
              env:
                - RES_VER: "prod_release"
                - RES_IMG: "c7nodall_dd_img"
                - RES_REPO: "c7nodall_dd_repo"
          script:
            - *tag_ship_assets
    on_success:
      script:
        - *tag_ship_assets_on_success

  - name: c7pytall_x8664_tag
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    integrations:
      - ship_ssh
    steps:
      - IN: prod_release
      - IN: c7pytall_dd_repo
        switch: off
      - IN: c7pytall_dd_img
        switch: off
      - TASK:
          name: c7pytall_tag
          runtime:
            options:
              env:
                - RES_VER: "prod_release"
                - RES_IMG: "c7pytall_dd_img"
                - RES_REPO: "c7pytall_dd_repo"
          script:
            - *tag_ship_assets
    on_success:
      script:
        - *tag_ship_assets_on_success

  - name: c7javall_x8664_tag
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    integrations:
      - ship_ssh
    steps:
      - IN: prod_release
      - IN: c7javall_dd_repo
        switch: off
      - IN: c7javall_dd_img
        switch: off
      - TASK:
          name: c7javall_tag
          runtime:
            options:
              env:
                - RES_VER: "prod_release"
                - RES_IMG: "c7javall_dd_img"
                - RES_REPO: "c7javall_dd_repo"
          script:
            - *tag_ship_assets
    on_success:
      script:
        - *tag_ship_assets_on_success

  - name: c7cppall_x8664_tag
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    integrations:
      - ship_ssh
    steps:
      - IN: prod_release
      - IN: c7cppall_dd_repo
        switch: off
      - IN: c7cppall_dd_img
        switch: off
      - TASK:
          name: c7cppall_tag
          runtime:
            options:
              env:
                - RES_VER: "prod_release"
                - RES_IMG: "c7cppall_dd_img"
                - RES_REPO: "c7cppall_dd_repo"
          script:
            - *tag_ship_assets
    on_success:
      script:
        - *tag_ship_assets_on_success

######################### GCP CentOS 7 Image ##################################
  - name: prep_c7_x8664_gce_img
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: trig_gcp_img_prep
      - IN: c7cppall_dd_img
      - IN: c7javall_dd_img
      - IN: c7pytall_dd_img
      - IN: c7nodall_dd_img
      - IN: node_file_pack
      - IN: buildami_repo
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - TASK:
          name: prep_c7_gce_image
          runtime:
            options:
              env:
                - NODE_RES: "node_file_pack"
                - SOURCE_IMAGE_FAMILY: "centos-7"
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - REL_VER: "master"
                - SSH_USER: "centos"
                - ARCHITECTURE: "x86_64"
                - OS: "CentOS_7"
                - DOCKER_VER: "18.03"
                - MODIFY_KERNEL: "false"
          script:
            - set -o pipefail
            - |
               export IMG_VER=$REL_VER
               export REL_VER_DASH=${REL_VER//./-}
               export FAM_NAME=$REL_VER_DASH"-prep-c7-x86-64"
            - |
               TAR_FILENAME=$(shipctl get_resource_version_key "$NODE_RES" "TAR_FILENAME")
               WEB_URL=$(shipctl get_resource_version_key "$NODE_RES" "WEB_URL")
               export NODE_DOWNLOAD_URL="$WEB_URL/$REL_VER/$TAR_FILENAME"
            - pushd $(shipctl get_resource_state "buildami_repo")/gcp/$ARCHITECTURE/$OS/prep
            - echo $(shipctl get_integration_resource_field ship_bits_gcp JSON_key) > $SERVICE_ACCOUNT_JSON
            - cp -R ../../../templates/linux/* .
            - cp -R ../../../templates/prep/* .
            - shipctl replace vars.json
            - packer validate -var-file=vars.json packer.json
            - packer build -machine-readable -var-file=vars.json packer.json 2>&1 | tee output.txt
            - export IMAGE_NAME=$(cat output.txt | awk -F, '$0 ~/artifact,0,id/ {print $6}' | cut -d':' -f 2)
    on_success:
      script:
        - shipctl put_resource_state_multi $JOB_NAME "versionName=$IMAGE_NAME" "IMAGE_NAME=$IMAGE_NAME" "IMAGE_FAM_NAME=$FAM_NAME" "REL_VER=$REL_VER"
        - shipctl put_resource_state_multi $JOB_NAME "ARCHITECTURE=$ARCHITECTURE" "OS=$OS" "DOCKER_VER=$DOCKER_VER" "NODE_WEB_URL=$WEB_URL" "NODE_TAR_FILENAME=$TAR_FILENAME"
        - shipctl copy_file_to_state images.txt
    on_failure:
      script:
        - cat output.txt

  - name: patch_c7_x8664_gce_img
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: prep_c7_x8664_gce_img
      - IN: u16reqProc_dd_img
      - IN: c7repLib_x8664_build
      - IN: reqKick_file_pack
      - IN: cexec_file_pack
      - IN: buildami_repo
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - TASK:
          name: patch_c7_gce_image
          runtime:
            options:
              env:
                - BASE_IMG_RES: "prep_c7_x8664_gce_img"
                - REQPROC_RES: "u16reqProc_dd_img"
                - REPORTS_RES: "c7repLib_x8664_build"
                - REQKICK_RES: "reqKick_file_pack"
                - CEXEC_RES: "cexec_file_pack"
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - SSH_USER: "centos"
          script:
            - set -o pipefail
            - |
               REL_VER=$(shipctl get_resource_version_key "$BASE_IMG_RES" "REL_VER")
               export ARCHITECTURE=$(shipctl get_resource_version_key "$BASE_IMG_RES" "ARCHITECTURE")
               export OS=$(shipctl get_resource_version_key "$BASE_IMG_RES" "OS")
               export DOCKER_VER=$(shipctl get_resource_version_key "$BASE_IMG_RES" "DOCKER_VER")
               export SOURCE_IMAGE_FAMILY=$(shipctl get_resource_version_key "$BASE_IMG_RES" "IMAGE_FAM_NAME")
               export NODE_WEB_URL=$(shipctl get_resource_version_key "$BASE_IMG_RES" "NODE_WEB_URL")
               export NODE_TAR_FILENAME=$(shipctl get_resource_version_key "$BASE_IMG_RES" "NODE_TAR_FILENAME")
               export REL_VER_DASH=${REL_VER//./-}
               export FAM_NAME=$REL_VER_DASH"-patch-c7-x86-64"
            - |
               REQPROC_REG=$(shipctl get_resource_version_key "$REQPROC_RES" "sourceName")
               REQPROC_TAG=$(shipctl get_resource_version_key "$REQPROC_RES" "versionName")
               export REQPROC_IMAGE="$REQPROC_REG:$REQPROC_TAG"
            - |
               REP_TAR_FILENAME=$(shipctl get_resource_version_key "$REPORTS_RES" "TAR_FILENAME")
               REP_WEB_URL=$(shipctl get_resource_version_key "$REPORTS_RES" "WEB_URL")
               export REPORTS_DOWNLOAD_URL="$REP_WEB_URL/$REL_VER/$REP_TAR_FILENAME"
            - |
               KICK_TAR_FILENAME=$(shipctl get_resource_version_key "$REQKICK_RES" "TAR_FILENAME")
               KICK_WEB_URL=$(shipctl get_resource_version_key "$REQKICK_RES" "WEB_URL")
               export REQKICK_DOWNLOAD_URL="$KICK_WEB_URL/$REL_VER/$KICK_TAR_FILENAME"
            - |
               CEXEC_TAR_FILENAME=$(shipctl get_resource_version_key "$CEXEC_RES" "TAR_FILENAME")
               CEXEC_WEB_URL=$(shipctl get_resource_version_key "$CEXEC_RES" "WEB_URL")
               export CEXEC_DOWNLOAD_URL="$CEXEC_WEB_URL/$REL_VER/$CEXEC_TAR_FILENAME"
            - pushd $(shipctl get_resource_state "buildami_repo")/gcp/$ARCHITECTURE/$OS/patch
            - cp -R ../../../templates/linux/* .
            - cp -R ../../../templates/patch/* .
            - shipctl copy_file_from_resource_state "$BASE_IMG_RES" "images.txt" .
            - echo $(shipctl get_integration_resource_field "ship_bits_gcp" "JSON_key") > $SERVICE_ACCOUNT_JSON
            - shipctl replace vars.json
            - packer validate -var-file=vars.json packer.json
            - packer build -machine-readable -var-file=vars.json packer.json 2>&1 | tee output.txt
            - export IMAGE_NAME=$(cat output.txt | awk -F, '$0 ~/artifact,0,id/ {print $6}' | cut -d':' -f 2)
    on_success:
      script:
        - shipctl put_resource_state_multi $JOB_NAME "versionName=$IMAGE_NAME" "IMAGE_NAME=$IMAGE_NAME" "IMAGE_FAM_NAME=$FAM_NAME" "REL_VER=$REL_VER" "ARCHITECTURE=$ARCHITECTURE" "OS=$OS" "DOCKER_VER=$DOCKER_VER"
        - shipctl put_resource_state_multi $JOB_NAME "NODE_WEB_URL=$NODE_WEB_URL" "NODE_TAR_FILENAME=$NODE_TAR_FILENAME"  "REPORTS_WEB_URL=$REP_WEB_URL" "REPORTS_TAR_FILENAME=$REP_TAR_FILENAME"
        - shipctl put_resource_state_multi $JOB_NAME "REQKICK_WEB_URL=$KICK_WEB_URL" "REQKICK_TAR_FILENAME=$KICK_TAR_FILENAME" "CEXEC_WEB_URL=$CEXEC_WEB_URL" "CEXEC_TAR_FILENAME=$CEXEC_TAR_FILENAME"
        - shipctl put_resource_state_multi $JOB_NAME "FAMILY_SUFFIX=c7-x86-64"
        - shipctl copy_file_to_state images.txt
    on_failure:
      script:
        - cat output.txt

  - name: v634_c7_x8664_gce_img
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: c7repLib_x8664_tag
      - IN: reqKick_repo_file_tag
      - IN: u16reqProc_dd_tag
      - IN: u16reqProc_dd_img
        switch: off
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - IN: patch_c7_x8664_gce_img
        switch: off
      - TASK:
          name: build_gce_image
          runtime:
            options:
              env:
                - BASE_IMG_RES: "patch_c7_x8664_gce_img"
                - NODE_RES: "node_repo_file_tag"
                - REQPROC_RES: "u16reqProc_dd_tag"
                - REQPROC_IMG_RES: "u16reqProc_dd_img"
                - REPORTS_RES: "c7repLib_x8664_tag"
                - REQKICK_RES: "reqKick_repo_file_tag"
                - CEXEC_RES: "cexec_repo_file_tag"
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - SSH_USER: "centos"
                - IMG_VER: "v6.3.4"
          script:
            - *regular_final
    on_success:
      script:
        - *final_on_success_template
    on_failure:
      script:
        - *final_on_failure_template

  - name: v644_c7_x8664_gce_img
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: c7repLib_x8664_tag
      - IN: reqKick_repo_file_tag
      - IN: u16reqProc_dd_tag
      - IN: u16reqProc_dd_img
        switch: off
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - IN: patch_c7_x8664_gce_img
        switch: off
      - TASK:
          name: build_gce_image
          runtime:
            options:
              env:
                - BASE_IMG_RES: "patch_c7_x8664_gce_img"
                - NODE_RES: "node_repo_file_tag"
                - REQPROC_RES: "u16reqProc_dd_tag"
                - REQPROC_IMG_RES: "u16reqProc_dd_img"
                - REPORTS_RES: "c7repLib_x8664_tag"
                - REQKICK_RES: "reqKick_repo_file_tag"
                - CEXEC_RES: "cexec_repo_file_tag"
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - SSH_USER: "centos"
                - IMG_VER: "v6.4.4"
          script:
            - *regular_final
    on_success:
      script:
        - *final_on_success_template
    on_failure:
      script:
        - *final_on_failure_template

  - name: v654_c7_x8664_gce_img
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: c7repLib_x8664_tag
      - IN: reqKick_repo_file_tag
      - IN: u16reqProc_dd_tag
      - IN: u16reqProc_dd_img
        switch: off
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - IN: patch_c7_x8664_gce_img
        switch: off
      - TASK:
          name: build_gce_image
          runtime:
            options:
              env:
                - BASE_IMG_RES: "patch_c7_x8664_gce_img"
                - NODE_RES: "node_repo_file_tag"
                - REQPROC_RES: "u16reqProc_dd_tag"
                - REQPROC_IMG_RES: "u16reqProc_dd_img"
                - REPORTS_RES: "c7repLib_x8664_tag"
                - REQKICK_RES: "reqKick_repo_file_tag"
                - CEXEC_RES: "cexec_repo_file_tag"
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - SSH_USER: "centos"
                - IMG_VER: "v6.5.4"
          script:
            - *regular_final
    on_success:
      script:
        - *final_on_success_template
    on_failure:
      script:
        - *final_on_failure_template

  - name: v664_c7_x8664_gce_img
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: c7repLib_x8664_tag
      - IN: reqKick_repo_file_tag
      - IN: u16reqProc_dd_tag
      - IN: u16reqProc_dd_img
        switch: off
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - IN: patch_c7_x8664_gce_img
        switch: off
      - TASK:
          name: build_gce_image
          runtime:
            options:
              env:
                - BASE_IMG_RES: "patch_c7_x8664_gce_img"
                - NODE_RES: "node_repo_file_tag"
                - REQPROC_RES: "u16reqProc_dd_tag"
                - REQPROC_IMG_RES: "u16reqProc_dd_img"
                - REPORTS_RES: "c7repLib_x8664_tag"
                - REQKICK_RES: "reqKick_repo_file_tag"
                - CEXEC_RES: "cexec_repo_file_tag"
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - SSH_USER: "centos"
                - IMG_VER: "v6.6.4"
          script:
            - *regular_final
    on_success:
      script:
        - *final_on_success_template
    on_failure:
      script:
        - *final_on_failure_template

  - name: v674_c7_x8664_gce_img
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: c7repLib_x8664_tag
      - IN: reqKick_repo_file_tag
      - IN: u16reqProc_dd_tag
      - IN: u16reqProc_dd_img
        switch: off
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - IN: patch_c7_x8664_gce_img
        switch: off
      - TASK:
          name: build_gce_image
          runtime:
            options:
              env:
                - BASE_IMG_RES: "patch_c7_x8664_gce_img"
                - NODE_RES: "node_repo_file_tag"
                - REQPROC_RES: "u16reqProc_dd_tag"
                - REQPROC_IMG_RES: "u16reqProc_dd_img"
                - REPORTS_RES: "c7repLib_x8664_tag"
                - REQKICK_RES: "reqKick_repo_file_tag"
                - CEXEC_RES: "cexec_repo_file_tag"
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - SSH_USER: "centos"
                - IMG_VER: "v6.7.4"
          script:
            - *regular_final
    on_success:
      script:
        - *final_on_success_template
    on_failure:
      script:
        - *final_on_failure_template

  - name: v684_c7_x8664_gce_img
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: c7repLib_x8664_tag
      - IN: reqKick_repo_file_tag
      - IN: u16reqProc_dd_tag
      - IN: u16reqProc_dd_img
        switch: off
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - IN: patch_c7_x8664_gce_img
        switch: off
      - TASK:
          name: build_gce_image
          runtime:
            options:
              env:
                - BASE_IMG_RES: "patch_c7_x8664_gce_img"
                - NODE_RES: "node_repo_file_tag"
                - REQPROC_RES: "u16reqProc_dd_tag"
                - REQPROC_IMG_RES: "u16reqProc_dd_img"
                - REPORTS_RES: "c7repLib_x8664_tag"
                - REQKICK_RES: "reqKick_repo_file_tag"
                - CEXEC_RES: "cexec_repo_file_tag"
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - SSH_USER: "centos"
                - IMG_VER: "v6.8.4"
          script:
            - *regular_final
    on_success:
      script:
        - *final_on_success_template
    on_failure:
      script:
        - *final_on_failure_template

  - name: v694_c7_x8664_gce_img
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: c7repLib_x8664_tag
      - IN: reqKick_repo_file_tag
      - IN: u16reqProc_dd_tag
      - IN: u16reqProc_dd_img
        switch: off
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - IN: patch_c7_x8664_gce_img
        switch: off
      - TASK:
          name: build_gce_image
          runtime:
            options:
              env:
                - BASE_IMG_RES: "patch_c7_x8664_gce_img"
                - NODE_RES: "node_repo_file_tag"
                - REQPROC_RES: "u16reqProc_dd_tag"
                - REQPROC_IMG_RES: "u16reqProc_dd_img"
                - REPORTS_RES: "c7repLib_x8664_tag"
                - REQKICK_RES: "reqKick_repo_file_tag"
                - CEXEC_RES: "cexec_repo_file_tag"
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - SSH_USER: "centos"
                - IMG_VER: "v6.9.4"
          script:
            - *regular_final
    on_success:
      script:
        - *final_on_success_template
    on_failure:
      script:
        - *final_on_failure_template

  - name: v6104_c7_x8664_gce_img
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: c7repLib_x8664_tag
      - IN: reqKick_repo_file_tag
      - IN: u16reqProc_dd_tag
      - IN: u16reqProc_dd_img
        switch: off
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: ship_bits_gcp
        switch: off
      - IN: patch_c7_x8664_gce_img
        switch: off
      - TASK:
          name: build_gce_image
          runtime:
            options:
              env:
                - BASE_IMG_RES: "patch_c7_x8664_gce_img"
                - NODE_RES: "node_repo_file_tag"
                - REQPROC_RES: "u16reqProc_dd_tag"
                - REQPROC_IMG_RES: "u16reqProc_dd_img"
                - REPORTS_RES: "c7repLib_x8664_tag"
                - REQKICK_RES: "reqKick_repo_file_tag"
                - CEXEC_RES: "cexec_repo_file_tag"
                - MACHINE_TYPE: "n1-standard-8"
                - REGION: "us-east1"
                - ZONE: "us-east1-b"
                - PROJECT_ID: "ship-bits"
                - SERVICE_ACCOUNT_JSON: "gcp_key.json"
                - SSH_USER: "centos"
                - IMG_VER: "v6.10.4"
          script:
            - *onetime_final
    on_success:
      script:
        - *final_on_success_template
    on_failure:
      script:
        - *final_on_failure_template

### AWS
  - name: c7baseami_prep
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: buildami_repo
        switch: off
      - IN: ami_bits_access_cli
        switch: off
      - IN: c7baseami_params
        switch: off
      - IN: c7nodall_dd_img
      - IN: c7cppall_dd_img
      - IN: c7pytall_dd_img
      - IN: c7javall_dd_img
      - IN: node_file_pack
      - IN: cexec_file_pack
      - IN: u16reqProc_x8664_build
      - IN: ami_reqKick_repo
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "buildami_repo")
            - cd c7Base
            - ./basePack.sh c7baseami_prep ami_bits_access_cli
            - popd
    on_failure:
      - script: pushd $(shipctl get_resource_state "buildami_repo")
      - script: cd c7Base
      - script: cat output.txt
      - script: popd

  - name: c7baseami_patch
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: buildami_repo
        switch: off
      - IN: ami_bits_access_cli
        switch: off
      - IN: c7baseami_params
        switch: off
      - IN: cexec_file_pack
      - IN: node_file_pack
      - IN: u16reqProc_x8664_build
      - IN: ami_reqKick_repo
      - IN: c7baseami_prep
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "buildami_repo")
            - cd c7BasePatch
            - ./basePatchPack.sh c7baseami_patch ami_bits_access_cli c7baseami_prep
            - popd
    on_failure:
      - script: cat $(shipctl get_resource_state buildami_repo)/c7BasePatch/output.txt

  - name: c7finalami_prep
    type: runSh
    triggerMode: parallel
    dependencyMode: strict
    steps:
      - IN: c7_x8664_tag
      - IN: c7all_x8664_tag
      - IN: c7nodall_x8664_tag
      - IN: c7pytall_x8664_tag
      - IN: c7javall_x8664_tag
      - IN: c7cppall_x8664_tag
      - IN: execTemplates_repo_file_tag
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: reqExec_repo_tag
      - IN: reqProc_repo_tag
      - IN: c7repLib_x8664_tag
      - IN: u14repLib_x8664_tag
      - IN: u16repLib_x8664_tag
      - IN: u16repLib_aarch64_tag
      - IN: buildami_repo
        switch: off
      - IN: c7baseami_patch
        switch: off
      - IN: prod_release
        switch: off
      - IN: c7baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off

      - TASK:
          script:
            - pushd $(shipctl get_resource_state "buildami_repo")
            - cd c7Exec
            - ./execPack.sh c7finalami_prep prod_release c7baseami_patch ami_bits_access
            - popd
    on_failure:
      - script: cat $(shipctl get_resource_state buildami_repo)/c7Exec/output.txt

  - name: c7_v634_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: execTemplates_repo_file_tag
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: reqExec_repo_tag
      - IN: reqProc_repo_tag
      - IN: c7repLib_x8664_tag
      - IN: u14repLib_x8664_tag
      - IN: u16repLib_x8664_tag
      - IN: u16repLib_aarch64_tag
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "buildami_repo")
            - cd c7Exec
            - ./execPackUpdate.sh c7_v634_update prod_release ami-1d8f3162 v634 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/buildami_repo/gitRepo/c7Exec/output.txt

  - name: c7_v644_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: execTemplates_repo_file_tag
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: reqExec_repo_tag
      - IN: reqProc_repo_tag
      - IN: c7repLib_x8664_tag
      - IN: u14repLib_x8664_tag
      - IN: u16repLib_x8664_tag
      - IN: u16repLib_aarch64_tag
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "buildami_repo")
            - cd c7Exec
            - ./execPackUpdate.sh c7_v644_update prod_release ami-737cc20c v644 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/buildami_repo/gitRepo/c7Exec/output.txt

  - name: c7_v654_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: execTemplates_repo_file_tag
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: reqExec_repo_tag
      - IN: reqProc_repo_tag
      - IN: c7repLib_x8664_tag
      - IN: u14repLib_x8664_tag
      - IN: u16repLib_x8664_tag
      - IN: u16repLib_aarch64_tag
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "buildami_repo")
            - cd c7Exec
            - ./execPackUpdate.sh c7_v654_update prod_release ami-09631c76 v654 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/buildami_repo/gitRepo/c7Exec/output.txt

  - name: c7_v664_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: execTemplates_repo_file_tag
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: reqExec_repo_tag
      - IN: reqProc_repo_tag
      - IN: c7repLib_x8664_tag
      - IN: u14repLib_x8664_tag
      - IN: u16repLib_x8664_tag
      - IN: u16repLib_aarch64_tag
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "buildami_repo")
            - cd c7Exec
            - ./execPackUpdate.sh c7_v664_update prod_release ami-4a1d3035 v664 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/buildami_repo/gitRepo/c7Exec/output.txt

  - name: c7_v674_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: execTemplates_repo_file_tag
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: reqExec_repo_tag
      - IN: reqProc_repo_tag
      - IN: c7repLib_x8664_tag
      - IN: u14repLib_x8664_tag
      - IN: u16repLib_x8664_tag
      - IN: u16repLib_aarch64_tag
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "buildami_repo")
            - cd c7Exec
            - ./execPackUpdate.sh c7_v674_update prod_release ami-35bca44a v674 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/buildami_repo/gitRepo/c7Exec/output.txt

  - name: c7_v684_update
    type: runSh
    dependencyMode: strict
    triggerMode: parallel
    steps:
      - IN: buildami_repo
        switch: off
      - IN: prod_release
        switch: off
      - IN: baseami_params
        switch: off
      - IN: ami_bits_access
        switch: off
      - IN: execTemplates_repo_file_tag
      - IN: node_repo_file_tag
      - IN: cexec_repo_file_tag
      - IN: reqExec_repo_tag
      - IN: reqProc_repo_tag
      - IN: c7repLib_x8664_tag
      - IN: u14repLib_x8664_tag
      - IN: u16repLib_x8664_tag
      - IN: u16repLib_aarch64_tag
      - TASK:
          script:
            - pushd $(shipctl get_resource_state "buildami_repo")
            - cd c7Exec
            - ./execPackUpdate.sh c7_v684_update prod_release ami-038dac92c92e934bb v684 ami_bits_access
            - popd
    on_failure:
      - script: cat /build/IN/buildami_repo/gitRepo/c7Exec/output.txt
